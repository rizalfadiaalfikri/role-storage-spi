# services:
#   # Keycloak dengan Custom Role Storage Provider
#   keycloak:
#     container_name: keycloak
#     build:
#       context: .
#       dockerfile: Dockerfile
#     extra_hosts:
#       # Untuk Windows/Mac: host.docker.internal otomatis tersedia
#       # Untuk Linux: gunakan IP host machine atau tambahkan: "host.docker.internal:host-gateway"
#       - "host.docker.internal:host-gateway"
#     environment:
#       # Keycloak Server Configuration
#       - KC_HOSTNAME=localhost
#       - KC_HOSTNAME_PORT=8080
#       - KC_HTTP_ENABLED=true
#       - KC_PROXY=edge
#       - KC_HEALTH_ENABLED=true
#       - KC_METRICS_ENABLED=true

#       # Keycloak Admin
#       - KEYCLOAK_ADMIN=admin
#       - KEYCLOAK_ADMIN_PASSWORD=admin

#       # Keycloak Database Configuration
#       # Sesuaikan dengan konfigurasi PostgreSQL lokal Anda
#       # host.docker.internal mengarah ke host machine dari dalam container
#       - KC_DB=postgres
#       - KC_DB_URL=jdbc:postgresql://host.docker.internal:5432/keycloak
#       - KC_DB_USERNAME=postgres
#       - KC_DB_PASSWORD=root

#       # Keycloak Features
#       - KC_FEATURES=preview,token-exchange,admin-fine-grained-authz:v1

#       # Custom Role Storage Provider Configuration (via system properties)
#       # Fallback jika tidak dikonfigurasi di Admin Console
#       # Sesuaikan port, database name, username, dan password dengan PostgreSQL lokal Anda
#       - JAVA_OPTS_APPEND=-Dquarkus.datasource.user-store.jdbc.url=jdbc:postgresql://host.docker.internal:5432/user_store -Dquarkus.datasource.user-store.username=postgres -Dquarkus.datasource.user-store.password=root -Dquarkus.datasource.user-store.db-kind=postgresql

#     ports:
#       - "8080:8080"
#       - "8443:8443"
#     networks:
#       - keycloak-network
#     volumes:
#       - keycloak_data:/opt/keycloak/data
#     restart: unless-stopped

# volumes:
#   keycloak_data:
#     driver: local

# networks:
#   keycloak-network:
#     driver: bridge

services:
  keycloak:
    container_name: keycloak
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - JAVA_OPTS_APPEND=-Dquarkus.datasource.user-store.jdbc.url=jdbc:postgresql://host.docker.internal:5432/user_store -Dquarkus.datasource.user-store.username=postgres -Dquarkus.datasource.user-store.password=root -Dquarkus.datasource.user-store.db-kind=postgresql
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      - KC_HOSTNAME=localhost
      - KC_HOSTNAME_PORT=8080
      - KC_HTTP_ENABLED=true
      - KC_PROXY=edge
      - KC_HEALTH_ENABLED=true
      - KC_METRICS_ENABLED=true
      - KEYCLOAK_ADMIN=admin
      - KEYCLOAK_ADMIN_PASSWORD=admin
      - KC_DB=postgres
      - KC_DB_URL=jdbc:postgresql://host.docker.internal:5432/keycloak
      - KC_DB_USERNAME=postgres
      - KC_DB_PASSWORD=root
      - KC_FEATURES=preview,token-exchange,admin-fine-grained-authz:v1
      - JAVA_OPTS_APPEND=-Dquarkus.datasource.user-store.jdbc.url=jdbc:postgresql://host.docker.internal:5432/user_store -Dquarkus.datasource.user-store.username=postgres -Dquarkus.datasource.user-store.password=root -Dquarkus.datasource.user-store.db-kind=postgresql
    ports:
      - "8080:8080"
      - "8443:8443"
    networks:
      - keycloak-network
    volumes:
      - keycloak_data:/opt/keycloak/data
    restart: unless-stopped

volumes:
  keycloak_data:
    driver: local

networks:
  keycloak-network:
    driver: bridge
